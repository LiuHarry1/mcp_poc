# ğŸ› ï¸ MCP Web Manager - åç«¯å¼€å‘æ–‡æ¡£

## ğŸ“ é¡¹ç›®ç»“æ„

```
mcp_test/
â”œâ”€â”€ client/                 # React å‰ç«¯
â”œâ”€â”€ server/                # Python åç«¯
â”‚   â”œâ”€â”€ mcp_web_server.py  # FastAPI æœåŠ¡å™¨
â”‚   â””â”€â”€ requirements.txt   # åç«¯ä¾èµ–
â”œâ”€â”€ mcp_server_file.py     # MCP æ–‡ä»¶å·¥å…·æœåŠ¡å™¨
â”œâ”€â”€ mcp_server_calc.py     # MCP è®¡ç®—å·¥å…·æœåŠ¡å™¨
â”œâ”€â”€ mcp_server_rest.py     # MCP REST API ç¤ºä¾‹æœåŠ¡å™¨
â”œâ”€â”€ mcp_servers_config.json # æœåŠ¡å™¨é…ç½®
â””â”€â”€ start.bat              # å¯åŠ¨è„šæœ¬
```

---

## ğŸš€ ç¯å¢ƒé…ç½®

### Python ç¯å¢ƒ

- **ç‰ˆæœ¬**: Python 3.11.13
- **ç¯å¢ƒ**: Conda ç¯å¢ƒ `mcp_env`
- **æ¿€æ´»**: `conda activate mcp_env`

### ä¾èµ–å®‰è£…

```bash
cd server
pip install -r requirements.txt
```

**ä¸»è¦ä¾èµ–**:
- fastapi - Web æ¡†æ¶
- uvicorn - ASGI æœåŠ¡å™¨
- websockets - WebSocket æ”¯æŒ
- mcp - MCP SDK
- dashscope - é€šä¹‰åƒé—® SDK
- requests - HTTP å®¢æˆ·ç«¯

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Frontend    â”‚  Port 3000
â”‚   (client/)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†•ï¸
    REST + WebSocket
          â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI Backend   â”‚  Port 8000
â”‚   (server/)         â”‚
â”‚   - MCPManager      â”‚
â”‚   - REST API        â”‚
â”‚   - WebSocket       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†•ï¸
    stdio / REST API
          â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MCP Servers       â”‚
â”‚   - stdio åè®®      â”‚
â”‚   - REST API åè®®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. MCPManager ç±»

**åŠŸèƒ½**:
- ç®¡ç† MCP æœåŠ¡å™¨è¿æ¥
- æ”¯æŒ stdio å’Œ REST ä¸¤ç§åè®®
- å·¥å…·å‘ç°å’Œè°ƒç”¨
- é€šä¹‰åƒé—®é›†æˆ

**ä¸»è¦æ–¹æ³•**:
```python
class MCPManager:
    async def connect_to_server(config)      # è¿æ¥æœåŠ¡å™¨
    async def disconnect_server(name)        # æ–­å¼€æœåŠ¡å™¨
    async def call_tool(tool_key, args)      # è°ƒç”¨å·¥å…·
    async def chat(message)                  # èŠå¤©æ¥å£
    def get_tools_for_qwen()                 # è·å–å·¥å…·åˆ—è¡¨
```

#### 2. API ç«¯ç‚¹

**æœåŠ¡å™¨ç®¡ç†**:
- `GET /api/servers` - è·å–æœåŠ¡å™¨åˆ—è¡¨
- `POST /api/servers` - æ·»åŠ æœåŠ¡å™¨
- `DELETE /api/servers/{name}` - åˆ é™¤æœåŠ¡å™¨
- `POST /api/servers/{name}/connect` - è¿æ¥
- `POST /api/servers/{name}/disconnect` - æ–­å¼€

**å·¥å…·ç®¡ç†**:
- `GET /api/tools` - è·å–å·¥å…·åˆ—è¡¨

**èŠå¤©**:
- `WebSocket /ws/chat` - å®æ—¶èŠå¤©

---

## ğŸ”Œ MCP æœåŠ¡å™¨åè®®

### stdio åè®®

**ç‰¹ç‚¹**:
- é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡
- å¯åŠ¨æœ¬åœ°è¿›ç¨‹
- ä½¿ç”¨ MCP SDK

**é…ç½®**:
```json
{
  "name": "file-server",
  "type": "stdio",
  "command": "python",
  "args": ["mcp_server_file.py"],
  "env": null
}
```

**å®ç°**:
```python
async def _connect_stdio_server(config):
    server_params = StdioServerParameters(
        command=config.command,
        args=config.args,
        env=config.env
    )
    
    stdio_transport = await stdio_client(server_params)
    session = ClientSession(stdio, write)
    await session.initialize()
    
    # è·å–å·¥å…·
    tools_list = await session.list_tools()
```

### REST API åè®®

**ç‰¹ç‚¹**:
- é€šè¿‡ HTTP REST API é€šä¿¡
- è¿æ¥è¿œç¨‹æœåŠ¡
- æ ‡å‡† HTTP è¯·æ±‚

**é…ç½®**:
```json
{
  "name": "rest-demo",
  "type": "rest",
  "url": "http://localhost:9000",
  "env": null
}
```

**å®ç°**:
```python
async def _connect_rest_server(config):
    base_url = config.url
    
    # è·å–å·¥å…·åˆ—è¡¨
    response = requests.get(f"{base_url}/mcp/tools")
    tools = response.json()
    
    # è°ƒç”¨å·¥å…·
    response = requests.post(
        f"{base_url}/mcp/call",
        json={"tool_name": name, "arguments": args}
    )
```

---

## ğŸ¤– é€šä¹‰åƒé—®é›†æˆ

### API é…ç½®

```python
DASHSCOPE_API_KEY = "sk-f256c03643e9491fb1ebc278dd958c2d"
dashscope.api_key = DASHSCOPE_API_KEY
```

### Function Calling

**å·¥å…·è½¬æ¢**:
```python
def get_tools_for_qwen():
    return [{
        "type": "function",
        "function": {
            "name": "server:tool",
            "description": "...",
            "parameters": {...}
        }
    }]
```

**è°ƒç”¨æµç¨‹**:
```python
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. è°ƒç”¨é€šä¹‰åƒé—® API
3. æ£€æŸ¥æ˜¯å¦æœ‰ tool_calls
4. æ‰§è¡Œå·¥å…·è°ƒç”¨
5. å°†ç»“æœè¿”å›ç»™ AI
6. è·å–æœ€ç»ˆç­”æ¡ˆ
```

---

## ğŸ“ åˆ›å»ºè‡ªå®šä¹‰ MCP Server

### stdio åè®®æœåŠ¡å™¨

```python
#!/usr/bin/env python3
from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent
from typing import Any, List

app = Server("my-server")

@app.list_tools()
async def list_tools() -> List[Tool]:
    return [
        Tool(
            name="my_tool",
            description="æˆ‘çš„å·¥å…·",
            inputSchema={
                "type": "object",
                "properties": {
                    "param": {"type": "string"}
                },
                "required": ["param"]
            }
        )
    ]

@app.call_tool()
async def call_tool(name: str, arguments: Any) -> List[TextContent]:
    if name == "my_tool":
        result = f"æ‰§è¡Œ: {arguments['param']}"
        return [TextContent(type="text", text=result)]

async def main():
    async with stdio_server() as (read_stream, write_stream):
        await app.run(read_stream, write_stream, 
                      app.create_initialization_options())

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

### REST API åè®®æœåŠ¡å™¨

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import Dict, Any, List
import uvicorn

app = FastAPI()

@app.get("/mcp/tools")
async def list_tools():
    return [
        {
            "name": "my_tool",
            "description": "æˆ‘çš„å·¥å…·",
            "parameters": {
                "type": "object",
                "properties": {
                    "param": {"type": "string"}
                },
                "required": ["param"]
            }
        }
    ]

@app.post("/mcp/call")
async def call_tool(request: dict):
    tool_name = request["tool_name"]
    arguments = request["arguments"]
    
    if tool_name == "my_tool":
        result = f"æ‰§è¡Œ: {arguments['param']}"
        return {
            "success": True,
            "result": result
        }
    
    return {
        "success": False,
        "error": "æœªçŸ¥å·¥å…·"
    }

if __name__ == "__main__":
    uvicorn.run(app, port=9001)
```

---

## ğŸ”§ å¼€å‘è°ƒè¯•

### åç«¯è°ƒè¯•

**å¯åŠ¨å¼€å‘æ¨¡å¼**:
```bash
cd server
python mcp_web_server.py
```

**æŸ¥çœ‹æ—¥å¿—**:
- Uvicorn æ—¥å¿—
- Python print è¾“å‡º
- å¼‚å¸¸å †æ ˆ

**API æ–‡æ¡£**:
```
http://localhost:8000/docs
```

### æµ‹è¯• API

**ä½¿ç”¨ curl**:
```bash
# è·å–æœåŠ¡å™¨åˆ—è¡¨
curl http://localhost:8000/api/servers

# è·å–å·¥å…·åˆ—è¡¨
curl http://localhost:8000/api/tools

# æ·»åŠ æœåŠ¡å™¨
curl -X POST http://localhost:8000/api/servers \
  -H "Content-Type: application/json" \
  -d '{"name":"test","type":"stdio","command":"python","args":["server.py"]}'
```

**ä½¿ç”¨ Postman**:
- å¯¼å…¥ OpenAPI è§„èŒƒ: http://localhost:8000/openapi.json
- æµ‹è¯•å„ä¸ªç«¯ç‚¹

### WebSocket æµ‹è¯•

**ä½¿ç”¨åœ¨çº¿å·¥å…·**:
```
URL: ws://localhost:8000/ws/chat
æ¶ˆæ¯: {"message": "test"}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### MCPServerConfig

```python
class MCPServerConfig(BaseModel):
    name: str                        # æœåŠ¡å™¨åç§°
    type: str = "stdio"              # "stdio" æˆ– "rest"
    command: Optional[str] = None    # stdio: å‘½ä»¤
    args: Optional[List[str]] = None # stdio: å‚æ•°
    url: Optional[str] = None        # rest: URL
    env: Optional[Dict] = None       # ç¯å¢ƒå˜é‡
```

### å·¥å…·ä¿¡æ¯

```python
{
    "server": "server-name",
    "server_type": "stdio" | "rest",
    "tool": Toolå¯¹è±¡ | dict,
    "base_url": "http://..."  # REST ç±»å‹æ‰æœ‰
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†

```python
# ä½¿ç”¨ async/await
async def connect_to_server(config):
    async with stdio_client(...) as transport:
        session = ClientSession(...)
        await session.initialize()
```

### è¿æ¥æ± 

- WebSocket è¿æ¥å¤ç”¨
- MCP ä¼šè¯ä¿æŒ
- å‡å°‘è¿æ¥å¼€é”€

### é”™è¯¯å¤„ç†

```python
try:
    result = await session.call_tool(...)
except Exception as e:
    return f"é”™è¯¯: {str(e)}"
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### API Key ç®¡ç†

```python
# ä½¿ç”¨ç¯å¢ƒå˜é‡
DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")

# ä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
# ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
```

### CORS é…ç½®

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # é™åˆ¶æ¥æº
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### è¾“å…¥éªŒè¯

```python
# ä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯
class ToolCallRequest(BaseModel):
    tool_name: str
    arguments: Dict[str, Any]
```

---

## ğŸ“¦ éƒ¨ç½²

### å¼€å‘ç¯å¢ƒ

```bash
cd server
python mcp_web_server.py
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
uvicorn server.mcp_web_server:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 4
```

### Docker éƒ¨ç½²

```dockerfile
FROM python:3.11

WORKDIR /app
COPY server/requirements.txt .
RUN pip install -r requirements.txt

COPY server/ ./server/
COPY mcp_server_*.py ./

CMD ["python", "server/mcp_web_server.py"]
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```python
import pytest
from server.mcp_web_server import MCPManager

@pytest.mark.asyncio
async def test_connect_server():
    manager = MCPManager()
    config = MCPServerConfig(...)
    result = await manager.connect_to_server(config)
    assert result["status"] == "success"
```

### é›†æˆæµ‹è¯•

```bash
# å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
python mcp_server_rest.py

# è¿è¡Œæµ‹è¯•
pytest tests/
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æ—¥å¿—è¾“å‡º

```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

logger.debug("è°ƒè¯•ä¿¡æ¯")
logger.info("æ™®é€šä¿¡æ¯")
logger.error("é”™è¯¯ä¿¡æ¯")
```

### å¼‚å¸¸è¿½è¸ª

```python
import traceback

try:
    ...
except Exception as e:
    traceback.print_exc()
```

### æ€§èƒ½åˆ†æ

```python
import time

start = time.time()
result = await call_tool(...)
print(f"è€—æ—¶: {time.time() - start}s")
```

---

## ğŸ“š API å‚è€ƒ

### REST API ç«¯ç‚¹

#### æœåŠ¡å™¨ç®¡ç†

**GET /api/servers**
```
å“åº”:
{
  "servers": [...],
  "connected": ["server1", "server2"]
}
```

**POST /api/servers**
```
è¯·æ±‚:
{
  "name": "my-server",
  "type": "stdio",
  "command": "python",
  "args": ["server.py"]
}

å“åº”:
{
  "status": "success",
  "config": {...}
}
```

**POST /api/servers/{name}/connect**
```
å“åº”:
{
  "status": "success",
  "tools": ["tool1", "tool2"]
}
```

#### å·¥å…·ç®¡ç†

**GET /api/tools**
```
å“åº”:
{
  "tools": [
    {
      "key": "server:tool",
      "name": "tool",
      "server": "server",
      "description": "...",
      "parameters": {...}
    }
  ]
}
```

#### WebSocket

**WS /ws/chat**

**å‘é€**:
```json
{"message": "ç”¨æˆ·æ¶ˆæ¯"}
```

**æ¥æ”¶**:
```json
{"type": "tool_call", "tool": "...", "arguments": {...}}
{"type": "tool_result", "tool": "...", "result": "..."}
{"type": "response", "content": "..."}
{"type": "error", "content": "..."}
```

---

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

```python
@app.get("/api/my-endpoint")
async def my_endpoint():
    return {"data": "..."}
```

### æ·»åŠ æ–°çš„å·¥å…·ç±»å‹

```python
# åœ¨ MCPManager ä¸­
async def _connect_custom_server(self, config):
    # è‡ªå®šä¹‰è¿æ¥é€»è¾‘
    pass
```

### è‡ªå®šä¹‰ AI æ¨¡å‹

```python
# æ›¿æ¢é€šä¹‰åƒé—®
from openai import OpenAI

client = OpenAI(api_key="...")
response = client.chat.completions.create(
    model="gpt-4",
    messages=messages,
    tools=tools
)
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### mcp_servers_config.json

```json
{
  "servers": [
    {
      "name": "æœåŠ¡å™¨åç§°",
      "type": "stdio" | "rest",
      
      // stdio ç±»å‹éœ€è¦:
      "command": "python",
      "args": ["script.py"],
      
      // rest ç±»å‹éœ€è¦:
      "url": "http://localhost:9000",
      
      // å¯é€‰:
      "env": {
        "API_KEY": "..."
      }
    }
  ]
}
```

### ç¯å¢ƒå˜é‡

```bash
# .env æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ° Gitï¼‰
DASHSCOPE_API_KEY=your-api-key
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å™¨è¿æ¥å¤±è´¥

**stdio æœåŠ¡å™¨**:
- æ£€æŸ¥å‘½ä»¤å’Œè·¯å¾„
- ç¡®è®¤æ–‡ä»¶å­˜åœ¨
- æŸ¥çœ‹ Python ç¯å¢ƒ

**REST æœåŠ¡å™¨**:
- ç¡®è®¤ URL å¯è®¿é—®
- æ£€æŸ¥ CORS é…ç½®
- æŸ¥çœ‹ REST Server æ—¥å¿—

### Q2: å·¥å…·è°ƒç”¨å¤±è´¥

**æ£€æŸ¥**:
- å·¥å…·å‚æ•°æ˜¯å¦æ­£ç¡®
- æœåŠ¡å™¨æ˜¯å¦å·²è¿æ¥
- æŸ¥çœ‹åç«¯æ—¥å¿—

### Q3: WebSocket æ–­å¼€

**åŸå› **:
- åç«¯é‡å¯
- ç½‘ç»œé—®é¢˜
- è¶…æ—¶

**è§£å†³**:
- è‡ªåŠ¨é‡è¿ï¼ˆå·²å®ç°ï¼‰
- åˆ·æ–°é¡µé¢

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´

- API è¯·æ±‚: < 100ms
- å·¥å…·è°ƒç”¨: < 1s
- WebSocket å»¶è¿Ÿ: < 50ms

### å¹¶å‘æ”¯æŒ

- åŒæ—¶è¿æ¥: 10+ æœåŠ¡å™¨
- å¹¶å‘å·¥å…·è°ƒç”¨: æ”¯æŒ
- WebSocket è¿æ¥: å¤šå®¢æˆ·ç«¯

---

## ğŸ” ç”Ÿäº§éƒ¨ç½²å»ºè®®

### å®‰å…¨

1. âœ… ä½¿ç”¨ HTTPS/WSS
2. âœ… API Key ç¯å¢ƒå˜é‡
3. âœ… CORS é™åˆ¶æ¥æº
4. âœ… è¾“å…¥éªŒè¯
5. âœ… é”™è¯¯å¤„ç†

### å¯é æ€§

1. âœ… å¼‚å¸¸æ•è·
2. âœ… è¶…æ—¶è®¾ç½®
3. âœ… é‡è¿æœºåˆ¶
4. âœ… å¥åº·æ£€æŸ¥

### ç›‘æ§

1. âœ… æ—¥å¿—è®°å½•
2. âœ… æ€§èƒ½ç›‘æ§
3. âœ… é”™è¯¯è¿½è¸ª

---

## ğŸ“š ç›¸å…³èµ„æº

- **MCP åè®®**: https://modelcontextprotocol.io
- **FastAPI æ–‡æ¡£**: https://fastapi.tiangolo.com
- **é€šä¹‰åƒé—®**: https://help.aliyun.com/zh/dashscope
- **MCP Python SDK**: https://github.com/modelcontextprotocol/python-sdk

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤

```bash
# å¼€å‘
cd server && python mcp_web_server.py

# æµ‹è¯•
pytest tests/

# API æ–‡æ¡£
http://localhost:8000/docs

# é‡å¯
Ctrl+C â†’ python mcp_web_server.py
```

---

**å®Œæ•´çš„åç«¯å¼€å‘æŒ‡å—ï¼** ğŸ› ï¸

